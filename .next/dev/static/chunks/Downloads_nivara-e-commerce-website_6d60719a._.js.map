{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/krish/Downloads/nivara-e-commerce-website/app/actions/orders.ts"],"sourcesContent":["\"use server\"\n\nimport { sql } from \"@/lib/db\"\nimport { getSession } from \"@/lib/session\"\nimport { revalidatePath } from \"next/cache\"\nimport { sendEmail, generateOrderNotificationEmail } from \"@/lib/email\"\n\ninterface OrderItem {\n  productId: number\n  quantity: number\n  price: number\n}\n\ninterface OrderData {\n  items: OrderItem[]\n  shippingAddress: any\n  shippingAddressId: number | null\n  paymentMethod: string\n  totalAmount: number\n}\n\nexport async function createOrder(data: OrderData) {\n  try {\n    const session = await getSession()\n\n    if (!session) {\n      return { error: \"Please sign in to place an order\" }\n    }\n\n    // Generate order number\n    const orderNumber = `NIVARA-${Date.now()}`\n\n    const order = await sql`\n      INSERT INTO orders (\n        user_id, \n        order_number, \n        total_amount, \n        status, \n        payment_status,\n        payment_type,\n        shipping_address,\n        shipping_address_id\n      )\n      VALUES (\n        ${session.userId},\n        ${orderNumber},\n        ${data.totalAmount},\n        'pending',\n        ${data.paymentMethod === \"cod\" ? \"pending\" : \"awaiting_payment\"},\n        ${data.paymentMethod},\n        ${data.shippingAddressId ? null : JSON.stringify(data.shippingAddress)},\n        ${data.shippingAddressId || null}\n      )\n      RETURNING id\n    `\n\n    const orderId = order[0].id\n\n    // Insert order items\n    for (const item of data.items) {\n      const product = await sql`\n        SELECT name, price FROM products WHERE id = ${item.productId}\n      `\n\n      await sql`\n        INSERT INTO order_items (order_id, product_id, product_name, product_price, quantity)\n        VALUES (${orderId}, ${item.productId}, ${product[0].name}, ${item.price}, ${item.quantity})\n      `\n    }\n\n    // Clear cart\n    await sql`\n      DELETE FROM cart_items WHERE user_id = ${session.userId}\n    `\n\n    revalidatePath(\"/cart\")\n    revalidatePath(\"/orders\")\n\n    // Send email notifications to admin emails\n    try {\n      // Get active admin emails\n      const adminEmailsResult = await sql`\n        SELECT email FROM admin_emails WHERE is_active = true\n      `\n      \n      const adminEmails = adminEmailsResult.map((row: any) => row.email)\n      \n      if (adminEmails.length > 0) {\n        // Get order details for email\n        const orderDetails = await sql`\n          SELECT o.*, u.full_name, u.email as customer_email, u.phone as customer_phone\n          FROM orders o\n          JOIN users u ON o.user_id = u.id\n          WHERE o.id = ${orderId}\n        `\n        \n        const orderItems = await sql`\n          SELECT * FROM order_items WHERE order_id = ${orderId}\n        `\n        \n        if (orderDetails.length > 0) {\n          const order = orderDetails[0]\n          const customer = {\n            full_name: order.full_name,\n            email: order.customer_email,\n            phone: order.customer_phone\n          }\n          \n          // Get shipping address\n          let shippingAddress = null\n          if (order.shipping_address_id) {\n            const addressResult = await sql`\n              SELECT * FROM addresses WHERE id = ${order.shipping_address_id}\n            `\n            if (addressResult.length > 0) {\n              shippingAddress = addressResult[0]\n            }\n          } else if (order.shipping_address) {\n            try {\n              shippingAddress = JSON.parse(order.shipping_address)\n            } catch (e) {\n              shippingAddress = {}\n            }\n          }\n          \n          if (shippingAddress) {\n            const emailHtml = generateOrderNotificationEmail(order, customer, orderItems, shippingAddress)\n            \n            await sendEmail({\n              to: adminEmails,\n              subject: `New Order #${order.order_number} Received`,\n              html: emailHtml\n            })\n          }\n        }\n      }\n    } catch (emailError) {\n      console.error(\"[v0] Failed to send order notification email:\", emailError)\n      // Don't fail the order creation if email sending fails\n    }\n\n    return { success: true, orderId, orderNumber }\n  } catch (error) {\n    console.error(\"[v0] Create order error:\", error)\n    return { error: \"Failed to create order\" }\n  }\n}\n\nexport async function cancelOrder(orderId: number) {\n  try {\n    const session = await getSession()\n\n    if (!session) {\n      return { error: \"Please sign in to cancel order\" }\n    }\n\n    // Check if order belongs to user\n    const order = await sql`\n      SELECT * FROM orders WHERE id = ${orderId} AND user_id = ${session.userId}\n    `\n\n    if (order.length === 0) {\n      return { error: \"Order not found\" }\n    }\n\n    // Only allow cancellation for pending or processing orders\n    if (![\"pending\", \"processing\"].includes(order[0].status)) {\n      return { error: \"Cannot cancel order in current status\" }\n    }\n\n    // Update order status\n    await sql`\n      UPDATE orders\n      SET status = 'cancelled'\n      WHERE id = ${orderId}\n    `\n\n    revalidatePath(\"/account\")\n    revalidatePath(\"/orders\")\n    revalidatePath(`/orders/${orderId}`)\n\n    return { success: true }\n  } catch (error) {\n    console.error(\"[v0] Cancel order error:\", error)\n    return { error: \"Failed to cancel order\" }\n  }\n}\n"],"names":[],"mappings":";;;;;;;IAoJsB,cAAA,WAAA,GAAA,IAAA,qSAAA,EAAA,8CAAA,0RAAA,EAAA,KAAA,GAAA,gSAAA,EAAA"}},
    {"offset": {"line": 19, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/krish/Downloads/nivara-e-commerce-website/app/actions/admin.ts"],"sourcesContent":["\"use server\"\n\nimport { cookies } from \"next/headers\"\nimport { revalidatePath } from \"next/cache\"\nimport { verifyAuth } from \"@/lib/session\"\nimport { sql } from \"@/lib/db\"\n\nexport async function updateOrderStatus(orderId: number, status: string) {\n  const cookieStore = await cookies()\n  const token = cookieStore.get(\"session\")?.value\n\n  if (!token) {\n    return { success: false, error: \"Unauthorized\" }\n  }\n\n  const user = await verifyAuth(token)\n  if (!user || user.role !== \"admin\") {\n    return { success: false, error: \"Unauthorized\" }\n  }\n\n  try {\n    await sql`\n      UPDATE orders\n      SET status = ${status}, updated_at = CURRENT_TIMESTAMP\n      WHERE id = ${orderId}\n    `\n\n    revalidatePath(\"/admin/orders\")\n    return { success: true }\n  } catch (error) {\n    return { success: false, error: \"Failed to update order\" }\n  }\n}\n\nexport async function deleteProduct(productId: number) {\n  const cookieStore = await cookies()\n  const token = cookieStore.get(\"session\")?.value\n\n  if (!token) {\n    return { success: false, error: \"Unauthorized\" }\n  }\n\n  const user = await verifyAuth(token)\n  if (!user || user.role !== \"admin\") {\n    return { success: false, error: \"Unauthorized\" }\n  }\n\n  try {\n    await sql`\n      DELETE FROM products\n      WHERE id = ${productId}\n    `\n\n    revalidatePath(\"/admin/products\")\n    revalidatePath(\"/shop\")\n    return { success: true }\n  } catch (error) {\n    return { success: false, error: \"Failed to delete product\" }\n  }\n}\n\nexport async function addProduct(data: any) {\n  const cookieStore = await cookies()\n  const token = cookieStore.get(\"session\")?.value\n\n  if (!token) {\n    return { success: false, error: \"Unauthorized\" }\n  }\n\n  const user = await verifyAuth(token)\n  if (!user || user.role !== \"admin\") {\n    return { success: false, error: \"Unauthorized\" }\n  }\n\n  try {\n    const slug = data.name\n      .toLowerCase()\n      .replace(/[^a-z0-9]+/g, \"-\")\n      .replace(/(^-|-$)/g, \"\")\n\n    const imagesJson = JSON.stringify(Array.isArray(data.images) ? data.images : [data.image_url])\n\n    await sql`\n      INSERT INTO products (\n        name, slug, description, price, category_id, image_url, images, metal_purity, design_number\n      )\n      VALUES (\n        ${data.name}, ${slug}, ${data.description}, ${data.price}, \n        ${data.category_id}, ${data.image_url},\n        ${imagesJson}, ${data.metal_purity || null}, ${data.design_number || null}\n      )\n    `\n\n    revalidatePath(\"/admin/products\")\n    revalidatePath(\"/shop\")\n    return { success: true }\n  } catch (error) {\n    return { success: false, error: \"Failed to add product\" }\n  }\n}\n\nexport async function updateProduct(productId: number, data: any) {\n  const cookieStore = await cookies()\n  const token = cookieStore.get(\"session\")?.value\n\n  if (!token) {\n    return { success: false, error: \"Unauthorized\" }\n  }\n\n  const user = await verifyAuth(token)\n  if (!user || user.role !== \"admin\") {\n    return { success: false, error: \"Unauthorized\" }\n  }\n\n  try {\n    const imagesJson = JSON.stringify(Array.isArray(data.images) ? data.images : [data.image_url])\n\n    await sql`\n      UPDATE products\n      SET \n        name = ${data.name},\n        description = ${data.description},\n        price = ${data.price},\n        category_id = ${data.category_id},\n        image_url = ${data.image_url},\n        images = ${imagesJson},\n        metal_purity = ${data.metal_purity || null},\n        design_number = ${data.design_number || null},\n        updated_at = CURRENT_TIMESTAMP\n      WHERE id = ${productId}\n    `\n\n    revalidatePath(\"/admin/products\")\n    revalidatePath(\"/shop\")\n    revalidatePath(`/products/${productId}`)\n    return { success: true }\n  } catch (error) {\n    return { success: false, error: \"Failed to update product\" }\n  }\n}\n\nexport async function addCategory(data: {\n  name: string\n  description: string\n  image_url: string\n  seo_title?: string\n  seo_description?: string\n}) {\n  const cookieStore = await cookies()\n  const token = cookieStore.get(\"session\")?.value\n\n  if (!token) {\n    return { success: false, error: \"Unauthorized\" }\n  }\n\n  const user = await verifyAuth(token)\n  if (!user || user.role !== \"admin\") {\n    return { success: false, error: \"Unauthorized\" }\n  }\n\n  try {\n    const slug = data.name\n      .toLowerCase()\n      .replace(/[^a-z0-9]+/g, \"-\")\n      .replace(/(^-|-$)/g, \"\")\n\n    const seoTitle = data.seo_title || `${data.name} | NIVARA Jewellery`\n    const seoDescription = data.seo_description || data.description\n\n    await sql`\n      INSERT INTO categories (name, slug, description, image_url, meta_title, meta_description)\n      VALUES (${data.name}, ${slug}, ${data.description}, ${data.image_url}, ${seoTitle}, ${seoDescription})\n    `\n\n    revalidatePath(\"/admin/categories\")\n    revalidatePath(\"/shop\")\n    revalidatePath(\"/categories\")\n    return { success: true }\n  } catch (error) {\n    return { success: false, error: \"Failed to add category\" }\n  }\n}\n\nexport async function updateCategory(\n  categoryId: number,\n  data: { name: string; description: string; image_url: string; seo_title?: string; seo_description?: string },\n) {\n  const cookieStore = await cookies()\n  const token = cookieStore.get(\"session\")?.value\n\n  if (!token) {\n    return { success: false, error: \"Unauthorized\" }\n  }\n\n  const user = await verifyAuth(token)\n  if (!user || user.role !== \"admin\") {\n    return { success: false, error: \"Unauthorized\" }\n  }\n\n  try {\n    const slug = data.name\n      .toLowerCase()\n      .replace(/[^a-z0-9]+/g, \"-\")\n      .replace(/(^-|-$)/g, \"\")\n\n    const seoTitle = data.seo_title || `${data.name} | NIVARA Jewellery`\n    const seoDescription = data.seo_description || data.description\n\n    await sql`\n      UPDATE categories\n      SET \n        name = ${data.name},\n        slug = ${slug},\n        description = ${data.description},\n        image_url = ${data.image_url},\n        meta_title = ${seoTitle},\n        meta_description = ${seoDescription}\n      WHERE id = ${categoryId}\n    `\n\n    revalidatePath(\"/admin/categories\")\n    revalidatePath(\"/shop\")\n    revalidatePath(`/categories/${slug}`)\n    return { success: true }\n  } catch (error) {\n    return { success: false, error: \"Failed to update category\" }\n  }\n}\n\nexport async function deleteCategory(categoryId: number) {\n  const cookieStore = await cookies()\n  const token = cookieStore.get(\"session\")?.value\n\n  if (!token) {\n    return { success: false, error: \"Unauthorized\" }\n  }\n\n  const user = await verifyAuth(token)\n  if (!user || user.role !== \"admin\") {\n    return { success: false, error: \"Unauthorized\" }\n  }\n\n  try {\n    await sql`\n      DELETE FROM categories\n      WHERE id = ${categoryId}\n    `\n\n    revalidatePath(\"/admin/categories\")\n    revalidatePath(\"/shop\")\n    return { success: true }\n  } catch (error) {\n    return { success: false, error: \"Failed to delete category\" }\n  }\n}\n\nexport async function cancelOrder(orderId: number) {\n  const cookieStore = await cookies()\n  const token = cookieStore.get(\"session\")?.value\n\n  if (!token) {\n    return { success: false, error: \"Unauthorized\" }\n  }\n\n  const user = await verifyAuth(token)\n  if (!user || user.role !== \"admin\") {\n    return { success: false, error: \"Unauthorized\" }\n  }\n\n  try {\n    // Check if order exists\n    const order = await sql`\n      SELECT * FROM orders WHERE id = ${orderId}\n    `\n\n    if (order.length === 0) {\n      return { success: false, error: \"Order not found\" }\n    }\n\n    // Only allow cancellation for pending or processing orders\n    if (![\"pending\", \"processing\"].includes(order[0].status)) {\n      return { success: false, error: \"Cannot cancel order in current status\" }\n    }\n\n    // Update order status\n    await sql`\n      UPDATE orders\n      SET status = 'cancelled'\n      WHERE id = ${orderId}\n    `\n\n    revalidatePath(\"/admin/orders\")\n    revalidatePath(`/admin/orders/${orderId}`)\n    return { success: true }\n  } catch (error) {\n    console.error(\"[v0] Cancel order error:\", error)\n    return { success: false, error: \"Failed to cancel order\" }\n  }\n}"],"names":[],"mappings":";;;;;;;IAgQsB,cAAA,WAAA,GAAA,IAAA,qSAAA,EAAA,8CAAA,0RAAA,EAAA,KAAA,GAAA,gSAAA,EAAA"}},
    {"offset": {"line": 34, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/krish/Downloads/nivara-e-commerce-website/components/cancel-order-button.tsx"],"sourcesContent":["\"use client\"\n\nimport { useState } from \"react\"\nimport { Button } from \"@/components/ui/button\"\nimport { cancelOrder } from \"@/app/actions/orders\"\nimport { cancelOrder as adminCancelOrder } from \"@/app/actions/admin\"\nimport { useRouter } from \"next/navigation\"\nimport { useToast } from \"@/hooks/use-toast\"\n\ninterface CancelOrderButtonProps {\n  orderId: number\n  isAdmin?: boolean\n}\n\nexport function CancelOrderButton({ orderId, isAdmin = false }: CancelOrderButtonProps) {\n  const [loading, setLoading] = useState(false)\n  const router = useRouter()\n  const { toast } = useToast()\n\n  async function handleCancel() {\n    if (!confirm(\"Are you sure you want to cancel this order?\")) {\n      return\n    }\n\n    setLoading(true)\n    const result = isAdmin ? await adminCancelOrder(orderId) : await cancelOrder(orderId)\n    setLoading(false)\n\n    if (result.error) {\n      toast({\n        title: \"Error\",\n        description: result.error,\n        variant: \"destructive\",\n      })\n    } else {\n      toast({\n        title: \"Order cancelled\",\n        description: \"Your order has been cancelled successfully\",\n      })\n      router.refresh()\n    }\n  }\n\n  return (\n    <Button variant=\"destructive\" size=\"sm\" onClick={handleCancel} disabled={loading} className=\"w-full\">\n      {loading ? \"Cancelling...\" : \"Cancel Order\"}\n    </Button>\n  )\n}\n"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;AACA;AACA;AACA;;;AAPA;;;;;;;AAcO,SAAS,kBAAkB,EAAE,OAAO,EAAE,UAAU,KAAK,EAA0B;;IACpF,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,4NAAQ,EAAC;IACvC,MAAM,SAAS,IAAA,qMAAS;IACxB,MAAM,EAAE,KAAK,EAAE,GAAG,IAAA,uLAAQ;IAE1B,eAAe;QACb,IAAI,CAAC,QAAQ,gDAAgD;YAC3D;QACF;QAEA,WAAW;QACX,MAAM,SAAS,UAAU,MAAM,IAAA,2NAAgB,EAAC,WAAW,MAAM,IAAA,2NAAW,EAAC;QAC7E,WAAW;QAEX,IAAI,OAAO,KAAK,EAAE;YAChB,MAAM;gBACJ,OAAO;gBACP,aAAa,OAAO,KAAK;gBACzB,SAAS;YACX;QACF,OAAO;YACL,MAAM;gBACJ,OAAO;gBACP,aAAa;YACf;YACA,OAAO,OAAO;QAChB;IACF;IAEA,qBACE,gPAAC,2LAAM;QAAC,SAAQ;QAAc,MAAK;QAAK,SAAS;QAAc,UAAU;QAAS,WAAU;kBACzF,UAAU,kBAAkB;;;;;;AAGnC;GAlCgB;;QAEC,qMAAS;QACN,uLAAQ;;;KAHZ"}},
    {"offset": {"line": 109, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/krish/Downloads/nivara-e-commerce-website/node_modules/next/src/build/webpack/loaders/next-flight-loader/action-client-wrapper.ts"],"sourcesContent":["// This file must be bundled in the app's client layer, it shouldn't be directly\n// imported by the server.\n\nexport { callServer } from 'next/dist/client/app-call-server'\nexport { findSourceMapURL } from 'next/dist/client/app-find-source-map-url'\n\n// A noop wrapper to let the Flight client create the server reference.\n// See also: https://github.com/facebook/react/pull/26632\n// eslint-disable-next-line import/no-extraneous-dependencies\nexport { createServerReference } from 'react-server-dom-webpack/client'\n"],"names":["callServer","createServerReference","findSourceMapURL"],"mappings":"AAAA,gFAAgF;AAChF,0BAA0B;;;;;;;;;;;;;;;;IAEjBA,UAAU,EAAA;eAAVA,eAAAA,UAAU;;IAMVC,qBAAqB,EAAA;eAArBA,QAAAA,qBAAqB;;IALrBC,gBAAgB,EAAA;eAAhBA,qBAAAA,gBAAgB;;;+BADE;qCACM;wBAKK","ignoreList":[0]}},
    {"offset": {"line": 142, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/krish/Downloads/nivara-e-commerce-website/node_modules/next/navigation.js"],"sourcesContent":["module.exports = require('./dist/client/components/navigation')\n"],"names":[],"mappings":"AAAA,OAAO,OAAO","ignoreList":[0]}}]
}