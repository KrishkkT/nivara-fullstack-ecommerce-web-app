{"version":3,"sources":["../../../../app/actions/orders.ts","../../../../.next-internal/server/app/admin/orders/%5Bid%5D/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["\"use server\"\n\nimport { sql } from \"@/lib/db\"\nimport { getSession } from \"@/lib/session\"\nimport { revalidatePath } from \"next/cache\"\nimport { sendEmail, generateOrderCancellationEmail } from \"@/lib/email\"\n\ninterface OrderItem {\n  productId: number\n  quantity: number\n  price: number\n}\n\ninterface OrderData {\n  items: OrderItem[]\n  shippingAddress: any\n  shippingAddressId: number | null\n  paymentMethod: string\n  totalAmount: number\n}\n\nexport async function createOrder(data: OrderData) {\n  try {\n    const session = await getSession()\n\n    if (!session) {\n      return { error: \"Please sign in to place an order\" }\n    }\n\n    // Generate order number\n    const orderNumber = `NIVARA-${Date.now()}`\n\n    const order: any = await sql`\n      INSERT INTO orders (\n        user_id, \n        order_number, \n        total_amount, \n        status, \n        payment_status,\n        payment_type,\n        shipping_address,\n        shipping_address_id\n      )\n      VALUES (\n        ${session.userId},\n        ${orderNumber},\n        ${data.totalAmount},\n        'pending',\n        'awaiting_payment',\n        ${data.paymentMethod},\n        ${data.shippingAddressId ? null : JSON.stringify(data.shippingAddress)},\n        ${data.shippingAddressId || null}\n      )\n      RETURNING id\n    `\n\n    const orderId = order[0].id\n\n    // Insert order items\n    for (const item of data.items) {\n      const product: any = await sql`\n        SELECT name, price FROM products WHERE id = ${item.productId}\n      `\n\n      await sql`\n        INSERT INTO order_items (order_id, product_id, product_name, product_price, quantity)\n        VALUES (${orderId}, ${item.productId}, ${product[0].name}, ${item.price}, ${item.quantity})\n      `\n    }\n\n    // Clear cart\n    await sql`\n      DELETE FROM cart_items WHERE user_id = ${session.userId}\n    `\n\n    revalidatePath(\"/cart\")\n    revalidatePath(\"/orders\")\n    // Revalidate the cart count API endpoint to update the cart counter\n    revalidatePath(\"/api/cart/count\")\n\n    // Save the checkout address as default if it's a new address\n    try {\n      // Only save if it's a new address (not from existing saved addresses)\n      if (!data.shippingAddressId && data.shippingAddress) {\n        // Check if this address already exists for this user\n        const existingAddresses: any = await sql`\n          SELECT id FROM addresses \n          WHERE user_id = ${session.userId}\n          AND address_line1 = ${data.shippingAddress.address_line1}\n          AND city = ${data.shippingAddress.city}\n          AND state = ${data.shippingAddress.state}\n          AND postal_code = ${data.shippingAddress.postal_code}\n        `\n\n        if (existingAddresses.length === 0) {\n          // Mark all existing addresses as non-default\n          await sql`\n            UPDATE addresses \n            SET is_default = false \n            WHERE user_id = ${session.userId}\n          `\n\n          // Save the new address as default\n          await sql`\n            INSERT INTO addresses (\n              user_id, \n              address_line1, \n              address_line2, \n              city, \n              state, \n              postal_code, \n              country, \n              is_default\n            )\n            VALUES (\n              ${session.userId},\n              ${data.shippingAddress.address_line1},\n              ${data.shippingAddress.address_line2 || ''},\n              ${data.shippingAddress.city},\n              ${data.shippingAddress.state},\n              ${data.shippingAddress.postal_code},\n              ${data.shippingAddress.country || 'India'},\n              true\n            )\n          `\n        } else {\n          // If address exists, make it the default\n          const addressId = existingAddresses[0].id\n          await sql`\n            UPDATE addresses \n            SET is_default = false \n            WHERE user_id = ${session.userId}\n          `\n          await sql`\n            UPDATE addresses \n            SET is_default = true \n            WHERE id = ${addressId}\n          `\n        }\n      } else if (data.shippingAddressId) {\n        // If using an existing address, make it the default\n        await sql`\n          UPDATE addresses \n          SET is_default = false \n          WHERE user_id = ${session.userId}\n        `\n        await sql`\n          UPDATE addresses \n          SET is_default = true \n          WHERE id = ${data.shippingAddressId}\n        `\n      }\n    } catch (addressError) {\n      console.error(\"[v0] Failed to save default address:\", addressError)\n      // Don't fail the order creation if address saving fails\n    }\n\n    // Email notifications will be sent after successful payment verification\n\n    return { success: true, orderId, orderNumber }\n  } catch (error) {\n    return { error: \"Failed to create order\" }\n  }\n}\n\nexport async function cancelOrder(orderId: number) {\n  try {\n    console.log(`[v0] User attempting to cancel order ${orderId}`);\n    \n    const session = await getSession()\n\n    if (!session) {\n      return { error: \"Please sign in to cancel order\" }\n    }\n\n    // Check if order belongs to user\n    const order: any = await sql`\n      SELECT * FROM orders WHERE id = ${orderId} AND user_id = ${session.userId}\n    `\n\n    if (order.length === 0) {\n      return { error: \"Order not found\" }\n    }\n\n    // Only allow cancellation for pending or processing orders\n    if (![\"pending\", \"processing\"].includes(order[0].status)) {\n      return { error: \"Cannot cancel order in current status\" }\n    }\n\n    // Get order details for email\n    const orderDetails: any = await sql`\n      SELECT o.*, u.full_name, u.email as customer_email, u.phone as customer_phone\n      FROM orders o\n      JOIN users u ON o.user_id = u.id\n      WHERE o.id = ${orderId} AND o.user_id = ${session.userId}\n    `\n\n    const orderItems: any = await sql`\n      SELECT * FROM order_items WHERE order_id = ${orderId}\n    `\n\n    // Update order status\n    await sql`\n      UPDATE orders\n      SET status = 'cancelled'\n      WHERE id = ${orderId}\n    `\n    \n    console.log(`[v0] Order ${orderId} cancelled successfully by user`);\n\n    // Send cancellation email to customer\n    if (orderDetails.length > 0) {\n      const order = orderDetails[0]\n      const customer = {\n        full_name: order.full_name,\n        email: order.customer_email,\n        phone: order.customer_phone\n      }\n\n      // Get shipping address\n      let shippingAddress = null\n      if (order.shipping_address_id) {\n        const addressResult: any = await sql`\n          SELECT * FROM addresses WHERE id = ${order.shipping_address_id}\n        `\n        if (addressResult.length > 0) {\n          shippingAddress = addressResult[0]\n        }\n      } else if (order.shipping_address) {\n        try {\n          shippingAddress = JSON.parse(order.shipping_address)\n        } catch (e) {\n          shippingAddress = {}\n        }\n      }\n\n      if (shippingAddress) {\n        try {\n          console.log(`[v0] Sending cancellation email to ${customer.email}`);\n          const emailHtml = generateOrderCancellationEmail(order, customer, orderItems, shippingAddress)\n          await sendEmail({\n            to: customer.email,\n            subject: `Order #${order.order_number} Cancelled`,\n            html: emailHtml\n          })\n          console.log(`[v0] Cancellation email sent successfully to ${customer.email}`);\n        } catch (emailError) {\n          console.error(\"[v0] Failed to send cancellation email:\", emailError)\n        }\n      } else {\n        console.warn(\"[v0] No shipping address found for order, skipping cancellation email\");\n      }\n    }\n\n    revalidatePath(\"/account\")\n    revalidatePath(\"/orders\")\n    revalidatePath(`/orders/${orderId}`)\n\n    return { success: true }\n  } catch (error) {\n    console.error(\"[v0] Failed to cancel order:\", error);\n    return { error: \"Failed to cancel order\" }\n  }\n}","export {cancelOrder as '4068bf0181f24a199e2d852075c25992cf1639aea9'} from 'ACTIONS_MODULE0'\nexport {cancelOrder as '401afdf693e644ce4f0761bfd0af817d46732dc380'} from 'ACTIONS_MODULE1'\nexport {updateOrderStatus as '607aa12dcca34b8ecb9ba93bf72eca644316457d40'} from 'ACTIONS_MODULE1'\n"],"names":[],"mappings":"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"}